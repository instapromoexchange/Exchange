<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Instapromo — Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --dark: #1e1e2c;
      --light: #f8f9fa;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 12px;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:#f5f7ff;color:#333;line-height:1.6}
    header{background:var(--dark);color:#fff;padding:16px 24px;font-weight:600;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,0.1);position:sticky;top:0;z-index:100}
    main{padding:24px;max-width:1800px;margin:0 auto}
    .card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--card-shadow);margin-bottom:24px;overflow:hidden;transition:var(--transition)}
    .card:hover{box-shadow:0 6px 24px rgba(0,0,0,0.1)}
    .card-header{padding:20px;border-bottom:1px solid var(--light-gray);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .card-title{font-size:1.25rem;font-weight:600;color:var(--dark)}
    .card-body{padding:0;overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:800px}
    th,td{padding:16px;text-align:left;border-bottom:1px solid var(--light-gray)}
    th{background:#f8f9fc;font-weight:600;color:var(--dark);position:sticky;top:0}
    tr:hover{background:#f8f9ff}
    .btn{padding:8px 16px;border:0;border-radius:8px;cursor:pointer;font-weight:500;font-size:.875rem;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:6px}
    .btn:disabled{opacity:.7;cursor:not-allowed}
    .btn-sm{padding:6px 12px;font-size:.75rem}
    .btn-oky{background:var(--success);color:#fff}
    .btn-warn{background:var(--warning);color:#333}
    .btn-dng{background:var(--danger);color:#fff}
    .btn-paid{background:var(--primary);color:#fff}
    .btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.1)}
    .tag{padding:6px 12px;border-radius:100px;font-weight:600;font-size:.75rem;text-transform:uppercase;letter-spacing:.5px;display:inline-block}
    .tag-approved{background:#d1fae5;color:#065f46}
    .tag-rejected{background:#fee2e2;color:#7f1d1d}
    .tag-pending{background:#fef3c7;color:#92400e}
    .tag-completed{background:#dbeafe;color:#1e40af}
    input{padding:12px;border:1px solid var(--light-gray);border-radius:8px;width:100%;font-family:inherit;transition:var(--transition)}
    input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(67,97,238,.15)}
    #auth{margin:40px auto;max-width:400px;background:#fff;padding:32px;border-radius:var(--border-radius);box-shadow:var(--card-shadow)}
    .auth-header{text-align:center;margin-bottom:24px}
    .auth-title{font-size:1.5rem;font-weight:700;color:var(--dark);margin-bottom:8px}
    .auth-subtitle{color:var(--gray);font-size:.875rem}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:500;font-size:.875rem}
    #auth-msg{margin-top:16px;padding:12px;border-radius:8px;background:#fee2e2;color:#b91c1c;font-weight:500;text-align:center;font-size:.875rem}
    #logout{float:right;background:var(--danger)}
  </style>
</head>
<body>
<header>
  <div><i class="fas fa-bolt"></i> Instapromo Admin</div>
  <button id="logout" class="btn btn-dng" style="display:none"><i class="fas fa-sign-out-alt"></i> Logout</button>
</header>
<main>
  <!-- Login Form -->
  <section id="auth">
    <div class="auth-header">
      <h2 class="auth-title">Admin Login</h2>
      <p class="auth-subtitle">Access your administrator dashboard</p>
    </div>
    <div class="form-group">
      <label class="form-label" for="login-email">Email</label>
      <input id="login-email" type="email" placeholder="Enter your email">
    </div>
    <div class="form-group">
      <label class="form-label" for="login-pass">Password</label>
      <input id="login-pass" type="password" placeholder="Enter your password">
    </div>
    <button id="btn-login" class="btn btn-oky" style="width:100%"><i class="fas fa-lock-open"></i> Login</button>
    <div id="auth-msg" style="display: none;"></div>
  </section>

  <!-- App Panel -->
  <section id="app" style="display:none">
    <div class="card fade-in">
      <div class="card-header"><h2 class="card-title">Users</h2></div>
      <div class="card-body"><table><thead>
        <tr>
          <th>UID</th><th>Full Name</th><th>Social Profile</th><th>Followers</th>
          <th>Phone</th><th>Email</th><th>Total Submissions</th><th>Approved</th>
          <th>Pending</th><th>Rejected</th><th>Total Earnings</th><th>Available Balance</th>
        </tr></thead><tbody id="user-body"></tbody></table></div>
    </div>

    <div class="card fade-in">
      <div class="card-header"><h2 class="card-title">Submissions</h2></div>
      <div class="card-body"><table><thead>
        <tr>
          <th>Date</th><th>UID</th><th>Type</th><th>Status</th>
          <th>Earnings</th><th>Link</th><th>Action</th>
        </tr></thead><tbody id="sub-body"></tbody></table></div>
    </div>

    <div class="card fade-in">
      <div class="card-header"><h2 class="card-title">Withdrawals</h2></div>
      <div class="card-body"><table><thead>
        <tr>
          <th>Date</th><th>UID</th><th>Method</th><th>Details</th>
          <th>Amount</th><th>Status</th><th>Action</th>
        </tr></thead><tbody id="wd-body"></tbody></table></div>
    </div>

    <div class="card fade-in">
      <div class="card-header"><h2 class="card-title">Messages</h2></div>
      <div class="card-body"><table><thead>
        <tr>
          <th>Date</th><th>UID/Group</th><th>Name</th>
          <th>Subject</th><th>Email</th><th>Message</th><th>Action</th>
        </tr></thead><tbody id="msg-body"></tbody></table></div>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBm4VTr__mag1trF4jPZCgqt7gWwBItD58",
  authDomain: "exchange-a725e.firebaseapp.com",
  databaseURL: "https://exchange-a725e-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "exchange-a725e",
  storageBucket: "exchange-a725e.appspot.com",
  messagingSenderId: "47165517524",
  appId: "1:47165517524:web:7712aae884de7a498a1541"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const authBox=document.getElementById("auth"),appBox=document.getElementById("app");
const subBody=document.getElementById("sub-body"),wdBody=document.getElementById("wd-body"),msgBody=document.getElementById("msg-body");
const userBody=document.getElementById("user-body");const authMsg=document.getElementById("auth-msg");

document.getElementById("btn-login").onclick=async()=>{
  const email=document.getElementById("login-email").value,pass=document.getElementById("login-pass").value;
  const loginBtn=document.getElementById("btn-login");const originalText=loginBtn.innerHTML;
  loginBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Authenticating...';loginBtn.disabled=true;
  try{await signInWithEmailAndPassword(auth,email,pass);}catch(e){authMsg.innerText=e.message;authMsg.style.display='block';}
  finally{loginBtn.innerHTML=originalText;loginBtn.disabled=false;}
};

document.getElementById("logout").onclick=()=>signOut(auth);

onAuthStateChanged(auth,(u)=>{
  if(u&&u.email==="rudrchauhan877@gmail.com"){authBox.style.display="none";appBox.style.display="block";document.getElementById("logout").style.display="inline-flex";loadData();}
  else if(u){authMsg.innerText="No admin access";authMsg.style.display='block';}
  else{authBox.style.display="block";appBox.style.display="none";document.getElementById("logout").style.display="none";authMsg.style.display='none';}
});

function loadData(){
  let userStats={};
  // Submissions
  onValue(ref(db,"submissions"),snap=>{
    subBody.innerHTML="";userStats={};
    if(!snap.exists()){subBody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;">No submissions found</td></tr>';}
    snap.forEach(u=>{
      const uid=u.key;userStats[uid]=userStats[uid]||{approved:0,pending:0,rejected:0,totalSubmissions:0,earnings:0,withdrawals:0};
      u.forEach(ch=>{
        const v=ch.val();const id=ch.key;const st=v.status||"pending";const earn=v.earnings||0;
        userStats[uid].totalSubmissions++;userStats[uid][st]=(userStats[uid][st]||0)+1;
        if(st==="approved"||st==="completed"){userStats[uid].earnings+=earn;}
        subBody.innerHTML+=`
        <tr>
          <td>${new Date(v.createdAt).toLocaleString()}</td>
          <td>${uid}</td>
          <td>${v.type||"-"}</td>
          <td><span class="tag tag-${st}">${st}</span></td>
          <td><input type="number" id="earn-${uid}-${id}" value="${earn}" style="width:80px"></td>
          <td>${v.link?`<a href="${v.link}" target="_blank">open</a>`:"-"}</td>
          <td>
            <div class="btn-group">
              ${st==="pending"?`
                <button class="btn btn-oky btn-sm" onclick="setSubStatus('${uid}','${id}','approved')"><i class="fas fa-check"></i> Approve</button>
                <button class="btn btn-dng btn-sm" onclick="setSubStatus('${uid}','${id}','rejected')"><i class="fas fa-times"></i> Reject</button>`:
                `<span class="tag tag-${st}">${st.toUpperCase()}</span>`}
            </div>
          </td>
        </tr>`;
      });
    });
    renderUsers(userStats);
  });

  // Withdrawals
  onValue(ref(db,"withdrawals"),snap=>{
    wdBody.innerHTML="";
    if(!snap.exists()){wdBody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;">No withdrawal requests found</td></tr>';}
    snap.forEach(u=>{
      const uid=u.key;userStats[uid]=userStats[uid]||{approved:0,pending:0,rejected:0,totalSubmissions:0,earnings:0,withdrawals:0};
      u.forEach(ch=>{
        const v=ch.val();const id=ch.key;const st=v.status||"requested";
        if(st==="approved"||st==="completed"){userStats[uid].withdrawals+=(v.amount||0);}
        wdBody.innerHTML+=`
        <tr>
          <td>${new Date(v.createdAt).toLocaleString()}</td>
          <td>${uid}</td>
          <td>${v.method}</td>
          <td>${v.method==="upi"?v.upiId:(v.account||"-")}</td>
          <td>₹${v.amount}</td>
          <td><span class="tag tag-${st}">${st}</span></td>
          <td>
            <div class="btn-group">
              ${st==="requested"?`
                <button class="btn btn-oky btn-sm" onclick="setWdStatus('${uid}','${id}','approved')"><i class="fas fa-check"></i> Approve</button>
                <button class="btn btn-dng btn-sm" onclick="setWdStatus('${uid}','${id}','rejected')"><i class="fas fa-times"></i> Reject</button>`:""}
              ${st==="approved"?`
                <button class="btn btn-paid btn-sm" onclick="setWdStatus('${uid}','${id}','completed')"><i class="fas fa-money-check"></i> Mark Paid</button>`:""}
            </div>
          </td>
        </tr>`;
      });
    });
    renderUsers(userStats);
  });

  // Messages FIXED
  onValue(ref(db,"contactMessages"),snap=>{
    msgBody.innerHTML="";
    if(!snap.exists()){msgBody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:24px;">No messages found</td></tr>';}
    snap.forEach(group=>group.forEach(ch=>{
      const v=ch.val();const uid=group.key,id=ch.key;
      msgBody.innerHTML+=`
        <tr>
          <td>${new Date(v.createdAt).toLocaleString()}</td>
          <td>${uid}</td>
          <td>${v.name||"-"}</td>
          <td>${v.subject||"-"}</td>
          <td>${v.email||"-"}</td>
          <td>${v.message||"-"}</td>
          <td><button class="btn btn-dng btn-sm" onclick="delMsg('${uid}','${id}')"><i class="fas fa-trash"></i> Delete</button></td>
        </tr>`;
    }));
  });

  // Users
  function renderUsers(stats){
    onValue(ref(db,"users"),snap=>{
      userBody.innerHTML="";
      if(!snap.exists()){userBody.innerHTML='<tr><td colspan="12" style="text-align:center;padding:24px;">No users found</td></tr>';}
      snap.forEach(ch=>{
        const uid=ch.key,v=ch.val();
        const s=stats[uid]||{approved:0,pending:0,rejected:0,totalSubmissions:0,earnings:0,withdrawals:0};
        const balance=s.earnings-s.withdrawals;
        userBody.innerHTML+=`
          <tr>
            <td>${uid}</td>
            <td>${v.fullName||"-"}</td>
            <td>${v.socialProfile?`<a href="${v.socialProfile}" target="_blank">Profile</a>`:"-"}</td>
            <td>${v.followers||0}</td>
            <td>${v.phone||"-"}</td>
            <td>${v.email||"-"}</td>
            <td>${s.totalSubmissions}</td>
            <td>${s.approved}</td>
            <td>${s.pending}</td>
            <td>${s.rejected}</td>
            <td>₹${s.earnings}</td>
            <td>₹${balance}</td>
          </tr>`;
      });
    });
  }
}

window.setSubStatus=async(uid,id,status)=>{
  const inp=document.getElementById(`earn-${uid}-${id}`);const earnings=inp?parseInt(inp.value||0,10):0;
  await update(ref(db,`submissions/${uid}/${id}`),{status,earnings,updatedAt:Date.now()});
};
window.setWdStatus=async(uid,id,status)=>{await update(ref(db,`withdrawals/${uid}/${id}`),{status,updatedAt:Date.now()});};
window.delMsg=async(uid,id)=>{if(confirm("Are you sure you want to delete this message?")){await remove(ref(db,`contactMessages/${uid}/${id}`));}};
</script>
</body>
</html>
