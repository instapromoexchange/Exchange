<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Instapromo Exchange — Admin Panel</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    :root{--primary:#4361ee;--secondary:#3a0ca3;--accent:#f72585;--light:#f8f9fa;--dark:#111827;--danger:#dc3545;--success:#28a745;--warning:#ffc107}
    body{background:#f6f8ff;color:var(--dark);min-height:100vh;line-height:1.6}
    .container{width:100%;max-width:1400px;margin:0 auto;padding:0 16px}

    header{position:sticky;top:0;z-index:100;background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-content{display:flex;align-items:center;justify-content:space-between;padding:10px 0;}
    .logo{display:flex;align-items:center;gap:10px;cursor:pointer;}
    .logo h1{font-size:1.3rem}
    nav ul{list-style:none;display:flex;gap:14px;align-items:center}
    nav a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:8px;font-weight:600}
    nav a:hover{background:rgba(255,255,255,.18)}

    .admin-login{max-width:400px;margin:100px auto;padding:20px;background:#fff;border-radius:14px;box-shadow:0 12px 28px rgba(0,0,0,.08)}
    .admin-login h2{text-align:center;margin-bottom:20px;color:var(--primary)}
    .fg{margin-bottom:12px; position: relative;}
    .fg label{display:block;font-weight:700;margin-bottom:6px}
    .fc{width:100%;padding:12px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .fc:focus{outline:none;box-shadow:0 0 0 3px rgba(67,97,238,.18)}
    .btn{display:inline-block;padding:11px 20px;background:var(--accent);color:#fff;border-radius:999px;text-decoration:none;font-weight:800;cursor:pointer;border:0}
    .btn:hover{filter:brightness(.95);transform:translateY(-1px)}
    .btn-danger{background:var(--danger)}
    .btn-success{background:var(--success)}
    .btn-warning{background:var(--warning);color:#000}

    .password-container {
      position: relative;
      display: flex;
      align-items: center;
    }
    .password-toggle {
      position: absolute;
      right: 12px;
      cursor: pointer;
      color: #6b7280;
      transition: all 0.3s ease;
      background: none;
      border: none;
      padding: 4px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .password-toggle:hover {
      color: var(--primary);
      background-color: rgba(67, 97, 238, 0.1);
    }
    .password-toggle:active {
      transform: scale(0.95);
    }
    .password-toggle i {
      font-size: 1.1rem;
      transition: transform 0.3s ease;
    }
    .password-toggle.active i {
      transform: rotate(10deg);
    }

    .admin-dashboard{display:none;padding:20px 0}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:16px}
    .stat{background:#fff;border-radius:12px;padding:16px;text-align:center;box-shadow:0 10px 24px rgba(0,0,0,.08)}
    .stat i{font-size:1.8rem;color:var(--primary);margin-bottom:6px}

    .section-title{text-align:center;margin-bottom:26px}
    .section-title h2{color:var(--primary);margin-bottom:8px}

    .card{background:#fff;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.08);overflow:hidden;margin-bottom:20px}
    .card-header{padding:14px 16px;background:var(--primary);color:#fff;display:flex;justify-content:space-between;align-items:center}
    .card-body{padding:16px}

    table{width:100%;border-collapse:collapse}
    th, td{padding:12px;text-align:left;border-bottom:1px solid #e5e7eb}
    th{background:#f3f4f6;font-weight:700}
    tr:hover{background:#f9fafb}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid #e5e7eb;margin-bottom:12px}
    .tab{padding:8px 12px;background:#f3f4f6;border-radius:8px 8px 0 0;cursor:pointer;font-weight:700}
    .tab.active{background:#fff;border:1px solid #e5e7eb;border-bottom:0;color:var(--primary)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    .status{display:none;margin:0 auto 14px;max-width:520px;padding:12px 14px;border-radius:10px;font-weight:700}
    .status.show{display:block}
    .status.ok{background:rgba(16,185,129,.14);border:1px solid rgba(16,185,129,.35);color:#065f46}
    .status.err{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);color:#7f1d1d}

    .badge{padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .badge-success{background:rgba(16,185,129,.14);color:#065f46}
    .badge-warning{background:rgba(245,158,11,.14);color:#854d0e}
    .badge-danger{background:rgba(239,68,68,.12);color:#7f1d1d}
    .badge-info{background:rgba(59,130,246,.14);color:#1e40af}

    .action-btn{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:6px;cursor:pointer;border:none;font-weight:600;margin-right:5px}
    .action-btn i{margin-right:4px}
    .btn-approve{background:var(--success);color:#fff}
    .btn-reject{background:var(--danger);color:#fff}
    .btn-view{background:var(--primary);color:#fff}
    .btn-edit{background:var(--warning);color:#000}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-content{background:#fff;border-radius:14px;padding:20px;width:90%;max-width:600px;max-height:80vh;overflow:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid #e5e7eb}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer}

    .search-container{margin-bottom:16px;display:flex;gap:10px}
    .search-container input{flex:1}

    .pagination{display:flex;justify-content:center;margin-top:20px;gap:8px}
    .pagination button{padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:6px;cursor:pointer}
    .pagination button.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .pagination button:hover:not(.active){background:#f3f4f6}

    @media (max-width:768px){
      .stats{grid-template-columns:1fr 1fr}
      .card-header{flex-direction:column;align-items:flex-start;gap:10px}
    }
    @media (max-width:576px){
      .stats{grid-template-columns:1fr}
      .admin-login{margin:50px auto;padding:15px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container header-content">
      <div class="logo">
        <i class="fa-solid fa-exchange-alt"></i><h1>Instapromo Exchange Admin</h1>
      </div>
      <nav>
        <ul id="nav">
          <li id="nav-logout" style="display:none"><a href="#" id="logout">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Toast -->
  <div id="status" class="status"></div>

  <!-- Admin Login -->
  <div id="admin-login" class="admin-login">
    <h2><i class="fa-solid fa-lock"></i> Admin Login</h2>
    <div class="fg">
      <label>Email</label>
      <input id="admin-email" type="email" class="fc" placeholder="admin@example.com" value="rudrchauhan877@gmail.com">
    </div>
    <div class="fg">
      <label>Password</label>
      <div class="password-container">
        <input id="admin-pass" type="password" class="fc" placeholder="******">
        <button type="button" class="password-toggle" id="admin-pass-toggle">
          <i class="fas fa-eye"></i>
        </button>
      </div>
    </div>
    <button class="btn" style="width:100%" id="btn-admin-login">Login</button>
  </div>

  <!-- Admin Dashboard -->
  <div id="admin-dashboard" class="admin-dashboard container">
    <div class="section-title">
      <h2>Admin Dashboard</h2>
      <p>Manage users, submissions, and withdrawals</p>
    </div>

    <div class="stats">
      <div class="stat"><i class="fa-solid fa-users"></i><h3 id="total-users">0</h3><p>Total Users</p></div>
      <div class="stat"><i class="fa-solid fa-list"></i><h3 id="total-submissions">0</h3><p>Total Submissions</p></div>
      <div class="stat"><i class="fa-solid fa-hourglass-half"></i><h3 id="pending-submissions">0</h3><p>Pending Submissions</p></div>
      <div class="stat"><i class="fa-solid fa-money-bill-wave"></i><h3 id="pending-withdrawals">0</h3><p>Pending Withdrawals</p></div>
      <div class="stat"><i class="fa-solid fa-indian-rupee-sign"></i><h3 id="total-earnings">₹0</h3><p>Total Earnings</p></div>
      <div class="stat"><i class="fa-solid fa-envelope"></i><h3 id="unread-messages">0</h3><p>Unread Messages</p></div>
    </div>

    <div class="tabs" id="admin-tabs">
      <div class="tab active" data-tab="tab-users">Users</div>
      <div class="tab" data-tab="tab-submissions">Submissions</div>
      <div class="tab" data-tab="tab-withdrawals">Withdrawals</div>
      <div class="tab" data-tab="tab-messages">Messages</div>
      <div class="tab" data-tab="tab-brands">Brands</div>
      <div class="tab" data-tab="tab-campaigns">Campaigns</div>
    </div>

    <!-- Users Tab -->
    <div id="tab-users" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h3>User Management</h3>
          <div class="search-container">
            <input type="text" id="user-search" class="fc" placeholder="Search users...">
            <button class="btn" id="btn-refresh-users"><i class="fas fa-sync-alt"></i> Refresh</button>
          </div>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Followers</th>
                  <th>Social Profile</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-table-body"></tbody>
            </table>
          </div>
          <div class="pagination" id="users-pagination"></div>
        </div>
      </div>
    </div>

    <!-- Submissions Tab -->
    <div id="tab-submissions" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Content Submissions</h3>
          <div class="search-container">
            <input type="text" id="submission-search" class="fc" placeholder="Search submissions...">
            <select id="submission-filter" class="fc">
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Type</th>
                  <th>Link</th>
                  <th>Status</th>
                  <th>Earnings</th>
                  <th>Submitted</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="submissions-table-body"></tbody>
            </table>
          </div>
          <div class="pagination" id="submissions-pagination"></div>
        </div>
      </div>
    </div>

    <!-- Withdrawals Tab -->
    <div id="tab-withdrawals" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Withdrawal Requests</h3>
          <div class="search-container">
            <input type="text" id="withdrawal-search" class="fc" placeholder="Search withdrawals...">
            <select id="withdrawal-filter" class="fc">
              <option value="all">All Status</option>
              <option value="requested">Requested</option>
              <option value="processing">Processing</option>
              <option value="completed">Completed</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>User</th>
                  <th>Method</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Requested</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="withdrawals-table-body"></tbody>
            </table>
          </div>
          <div class="pagination" id="withdrawals-pagination"></div>
        </div>
      </div>
    </div>

    <!-- Messages Tab -->
    <div id="tab-messages" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Contact Messages</h3>
          <div class="search-container">
            <input type="text" id="message-search" class="fc" placeholder="Search messages...">
            <button class="btn" id="btn-mark-all-read"><i class="fas fa-check-double"></i> Mark All Read</button>
          </div>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Company</th>
                  <th>Email</th>
                  <th>Message</th>
                  <th>Received</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="messages-table-body"></tbody>
            </table>
          </div>
          <div class="pagination" id="messages-pagination"></div>
        </div>
      </div>
    </div>

    <!-- Brands Tab -->
    <div id="tab-brands" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Brand Management</h3>
          <button class="btn" id="btn-add-brand"><i class="fas fa-plus"></i> Add Brand</button>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Category</th>
                  <th>Campaigns</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="brands-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Campaigns Tab -->
    <div id="tab-campaigns" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Campaign Management</h3>
          <button class="btn" id="btn-add-campaign"><i class="fas fa-plus"></i> Add Campaign</button>
        </div>
        <div class="card-body">
          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th>Brand</th>
                  <th>Title</th>
                  <th>Payout</th>
                  <th>Requirements</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="campaigns-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submission Detail Modal -->
  <div class="modal" id="submission-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Submission Details</h3>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="fg">
          <label>User</label>
          <input type="text" id="modal-user" class="fc" readonly>
        </div>
        <div class="fg">
          <label>Content Type</label>
          <input type="text" id="modal-type" class="fc" readonly>
        </div>
        <div class="fg">
          <label>Content Link</label>
          <input type="text" id="modal-link" class="fc" readonly>
          <div style="margin-top:8px">
            <a href="#" id="modal-link-anchor" target="_blank" class="btn">View Content</a>
          </div>
        </div>
        <div class="fg">
          <label>Status</label>
          <select id="modal-status" class="fc">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
        </div>
        <div class="fg">
          <label>Earnings (₹)</label>
          <input type="number" id="modal-earnings" class="fc" min="0">
        </div>
        <div class="fg">
          <label>Admin Notes</label>
          <textarea id="modal-notes" class="fc" rows="3"></textarea>
        </div>
        <button class="btn btn-success" id="btn-save-submission" style="width:100%">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration (same as your main app)
    const firebaseConfig = {
      apiKey: "AIzaSyBm4VTr__mag1trF4jPZCgqt7gWwBItD58",
      authDomain: "exchange-a725e.firebaseapp.com",
      databaseURL: "https://exchange-a725e-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "exchange-a725e",
      storageBucket: "exchange-a725e.firebasestorage.app",
      messagingSenderId: "47165517524",
      appId: "1:47165517524:web:7712aae884de7a498a1541"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Global variables
    let currentUser = null;
    let currentSubmissionId = null;
    const itemsPerPage = 10;
    let currentUsersPage = 1;
    let currentSubmissionsPage = 1;
    let currentWithdrawalsPage = 1;
    let currentMessagesPage = 1;

    // Helper functions
    function showStatus(message, type = 'ok') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status show ${type}`;
      setTimeout(() => {
        statusEl.className = 'status';
      }, 3000);
    }

    function setupPasswordToggle(toggleId, inputId) {
      const toggle = document.getElementById(toggleId);
      const input = document.getElementById(inputId);
      
      toggle.addEventListener('click', () => {
        if (input.type === 'password') {
          input.type = 'text';
          toggle.classList.add('active');
          toggle.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
          input.type = 'password';
          toggle.classList.remove('active');
          toggle.innerHTML = '<i class="fas fa-eye"></i>';
        }
      });
    }

    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = new Date(timestamp);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function getStatusBadge(status) {
      switch(status) {
        case 'approved':
        case 'completed':
          return '<span class="badge badge-success">Approved</span>';
        case 'pending':
        case 'requested':
          return '<span class="badge badge-warning">Pending</span>';
        case 'rejected':
          return '<span class="badge badge-danger">Rejected</span>';
        case 'processing':
          return '<span class="badge badge-info">Processing</span>';
        default:
          return '<span class="badge">Unknown</span>';
      }
    }

    // Authentication
    document.getElementById('btn-admin-login').addEventListener('click', () => {
      const email = document.getElementById('admin-email').value;
      const password = document.getElementById('admin-pass').value;
      
      if (!email || !password) {
        showStatus('Please enter email and password', 'err');
        return;
      }
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          // Check if the user is an admin (rudrchauhan877@gmail.com)
          if (currentUser.email === 'rudrchauhan877@gmail.com') {
            showStatus('Admin login successful!', 'ok');
            document.getElementById('admin-login').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            document.getElementById('nav-logout').style.display = 'list-item';
            loadDashboardData();
          } else {
            auth.signOut();
            showStatus('Access denied. Admin privileges required.', 'err');
          }
        })
        .catch((error) => {
          showStatus(error.message, 'err');
        });
    });

    // Logout functionality
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault();
      auth.signOut().then(() => {
        showStatus('Logged out successfully', 'ok');
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('admin-dashboard').style.display = 'none';
        document.getElementById('nav-logout').style.display = 'none';
      }).catch((error) => {
        showStatus(error.message, 'err');
      });
    });

    // Tabs functionality
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');
        tab.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        // Load data for the selected tab if needed
        if (tabId === 'tab-users') loadUsers();
        if (tabId === 'tab-submissions') loadSubmissions();
        if (tabId === 'tab-withdrawals') loadWithdrawals();
        if (tabId === 'tab-messages') loadMessages();
        if (tabId === 'tab-brands') loadBrands();
        if (tabId === 'tab-campaigns') loadCampaigns();
      });
    });

    // Modal functionality
    document.querySelector('.modal-close').addEventListener('click', () => {
      document.getElementById('submission-modal').classList.remove('show');
    });

    // Load dashboard data
    function loadDashboardData() {
      // Load users count
      database.ref('users').once('value').then(snapshot => {
        document.getElementById('total-users').textContent = snapshot.numChildren();
      });
      
      // Load submissions count
      let totalSubmissions = 0;
      let pendingSubmissions = 0;
      database.ref('submissions').once('value').then(snapshot => {
        snapshot.forEach(userSnapshot => {
          totalSubmissions += userSnapshot.numChildren();
          userSnapshot.forEach(submission => {
            if (submission.val().status === 'pending') {
              pendingSubmissions++;
            }
          });
        });
        document.getElementById('total-submissions').textContent = totalSubmissions;
        document.getElementById('pending-submissions').textContent = pendingSubmissions;
      });
      
      // Load withdrawals count
      let pendingWithdrawals = 0;
      database.ref('withdrawals').once('value').then(snapshot => {
        snapshot.forEach(userSnapshot => {
          userSnapshot.forEach(withdrawal => {
            if (withdrawal.val().status === 'requested') {
              pendingWithdrawals++;
            }
          });
        });
        document.getElementById('pending-withdrawals').textContent = pendingWithdrawals;
      });
      
      // Load messages count
      let unreadMessages = 0;
      database.ref('contactMessages').once('value').then(snapshot => {
        snapshot.forEach(message => {
          if (!message.val().read) {
            unreadMessages++;
          }
        });
        document.getElementById('unread-messages').textContent = unreadMessages;
      });
      
      // Load total earnings (simplified calculation)
      let totalEarnings = 0;
      database.ref('submissions').once('value').then(snapshot => {
        snapshot.forEach(userSnapshot => {
          userSnapshot.forEach(submission => {
            if (submission.val().status === 'approved' && submission.val().earnings) {
              totalEarnings += submission.val().earnings;
            }
          });
        });
        document.getElementById('total-earnings').textContent = '₹' + totalEarnings;
      });
    }

    // Load users with pagination
    function loadUsers(page = 1) {
      database.ref('users').once('value').then(snapshot => {
        const users = [];
        snapshot.forEach(userSnapshot => {
          users.push({
            id: userSnapshot.key,
            ...userSnapshot.val()
          });
        });
        
        // Apply search filter if any
        const searchTerm = document.getElementById('user-search').value.toLowerCase();
        const filteredUsers = searchTerm ? 
          users.filter(user => 
            (user.name && user.name.toLowerCase().includes(searchTerm)) ||
            (user.email && user.email.toLowerCase().includes(searchTerm)) ||
            (user.social && user.social.toLowerCase().includes(searchTerm))
          ) : users;
        
        // Pagination
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        currentUsersPage = Math.min(page, totalPages);
        const startIndex = (currentUsersPage - 1) * itemsPerPage;
        const paginatedUsers = filteredUsers.slice(startIndex, startIndex + itemsPerPage);
        
        // Render users table
        const usersTableBody = document.getElementById('users-table-body');
        usersTableBody.innerHTML = '';
        
        paginatedUsers.forEach(user => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${user.name || '-'}</td>
            <td>${user.email || '-'}</td>
            <td>${user.followers || '0'}</td>
            <td><a href="${user.social || '#'}" target="_blank">View Profile</a></td>
            <td>${formatDate(user.createdAt)}</td>
            <td>
              <button class="action-btn btn-view" data-userid="${user.id}"><i class="fas fa-eye"></i> View</button>
            </td>
          `;
          usersTableBody.appendChild(row);
        });
        
        // Render pagination
        renderPagination('users-pagination', currentUsersPage, totalPages, loadUsers);
      });
    }

    // Load submissions with pagination
    function loadSubmissions(page = 1) {
      const statusFilter = document.getElementById('submission-filter').value;
      
      database.ref('submissions').once('value').then(snapshot => {
        const submissions = [];
        snapshot.forEach(userSnapshot => {
          userSnapshot.forEach(submissionSnapshot => {
            const submission = submissionSnapshot.val();
            submissions.push({
              id: submissionSnapshot.key,
              userId: userSnapshot.key,
              ...submission
            });
          });
        });
        
        // Apply filters
        let filteredSubmissions = submissions;
        if (statusFilter !== 'all') {
          filteredSubmissions = submissions.filter(s => s.status === statusFilter);
        }
        
        // Apply search if any
        const searchTerm = document.getElementById('submission-search').value.toLowerCase();
        if (searchTerm) {
          filteredSubmissions = filteredSubmissions.filter(s => 
            (s.type && s.type.toLowerCase().includes(searchTerm)) ||
            (s.link && s.link.toLowerCase().includes(searchTerm))
          );
        }
        
        // Sort by date (newest first)
        filteredSubmissions.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });
        
        // Pagination
        const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
        currentSubmissionsPage = Math.min(page, totalPages);
        const startIndex = (currentSubmissionsPage - 1) * itemsPerPage;
        const paginatedSubmissions = filteredSubmissions.slice(startIndex, startIndex + itemsPerPage);
        
        // Get user details for each submission
        const userPromises = paginatedSubmissions.map(submission => {
          return database.ref('users/' + submission.userId).once('value').then(userSnapshot => {
            return {
              ...submission,
              userName: userSnapshot.val()?.name || 'Unknown User',
              userEmail: userSnapshot.val()?.email || 'No email'
            };
          });
        });
        
        Promise.all(userPromises).then(submissionsWithUsers => {
          // Render submissions table
          const submissionsTableBody = document.getElementById('submissions-table-body');
          submissionsTableBody.innerHTML = '';
          
          submissionsWithUsers.forEach(submission => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${submission.userName}<br><small>${submission.userEmail}</small></td>
              <td>${submission.type || '-'}</td>
              <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                <a href="${submission.link}" target="_blank">${submission.link}</a>
              </td>
              <td>${getStatusBadge(submission.status)}</td>
              <td>₹${submission.earnings || '0'}</td>
              <td>${formatDate(submission.createdAt)}</td>
              <td>
                <button class="action-btn btn-edit" data-submissionid="${submission.id}" data-userid="${submission.userId}">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </td>
            `;
            submissionsTableBody.appendChild(row);
          });
          
          // Add event listeners to edit buttons
          document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', () => {
              const submissionId = btn.getAttribute('data-submissionid');
              const userId = btn.getAttribute('data-userid');
              openSubmissionModal(userId, submissionId);
            });
          });
          
          // Render pagination
          renderPagination('submissions-pagination', currentSubmissionsPage, totalPages, loadSubmissions);
        });
      });
    }

    // Open submission modal for editing
    function openSubmissionModal(userId, submissionId) {
      currentSubmissionId = { userId, submissionId };
      
      database.ref(`submissions/${userId}/${submissionId}`).once('value').then(snapshot => {
        const submission = snapshot.val();
        if (!submission) return;
        
        // Get user details
        database.ref('users/' + userId).once('value').then(userSnapshot => {
          const user = userSnapshot.val();
          
          // Populate modal
          document.getElementById('modal-user').value = user?.name || 'Unknown User';
          document.getElementById('modal-type').value = submission.type || '';
          document.getElementById('modal-link').value = submission.link || '';
          document.getElementById('modal-link-anchor').href = submission.link || '#';
          document.getElementById('modal-status').value = submission.status || 'pending';
          document.getElementById('modal-earnings').value = submission.earnings || 0;
          document.getElementById('modal-notes').value = submission.adminNotes || '';
          
          // Show modal
          document.getElementById('submission-modal').classList.add('show');
        });
      });
    }

    // Save submission changes
    document.getElementById('btn-save-submission').addEventListener('click', () => {
      if (!currentSubmissionId) return;
      
      const updates = {
        status: document.getElementById('modal-status').value,
        earnings: parseFloat(document.getElementById('modal-earnings').value) || 0,
        adminNotes: document.getElementById('modal-notes').value,
        reviewedAt: Date.now()
      };
      
      database.ref(`submissions/${currentSubmissionId.userId}/${currentSubmissionId.submissionId}`).update(updates)
        .then(() => {
          showStatus('Submission updated successfully!', 'ok');
          document.getElementById('submission-modal').classList.remove('show');
          loadSubmissions(currentSubmissionsPage);
          loadDashboardData(); // Refresh dashboard stats
        })
        .catch(error => {
          showStatus('Error updating submission: ' + error.message, 'err');
        });
    });

    // Load withdrawals
    function loadWithdrawals(page = 1) {
      const statusFilter = document.getElementById('withdrawal-filter').value;
      
      database.ref('withdrawals').once('value').then(snapshot => {
        const withdrawals = [];
        snapshot.forEach(userSnapshot => {
          userSnapshot.forEach(withdrawalSnapshot => {
            const withdrawal = withdrawalSnapshot.val();
            withdrawals.push({
              id: withdrawalSnapshot.key,
              userId: userSnapshot.key,
              ...withdrawal
            });
          });
        });
        
        // Apply filters
        let filteredWithdrawals = withdrawals;
        if (statusFilter !== 'all') {
          filteredWithdrawals = withdrawals.filter(w => w.status === statusFilter);
        }
        
        // Apply search if any
        const searchTerm = document.getElementById('withdrawal-search').value.toLowerCase();
        if (searchTerm) {
          filteredWithdrawals = filteredWithdrawals.filter(w => 
            (w.method && w.method.toLowerCase().includes(searchTerm))
          );
        }
        
        // Sort by date (newest first)
        filteredWithdrawals.sort((a, b) => {
          const dateA = new Date(a.requestedAt || 0);
          const dateB = new Date(b.requestedAt || 0);
          return dateB - dateA;
        });
        
        // Pagination
        const totalPages = Math.ceil(filteredWithdrawals.length / itemsPerPage);
        currentWithdrawalsPage = Math.min(page, totalPages);
        const startIndex = (currentWithdrawalsPage - 1) * itemsPerPage;
        const paginatedWithdrawals = filteredWithdrawals.slice(startIndex, startIndex + itemsPerPage);
        
        // Get user details for each withdrawal
        const userPromises = paginatedWithdrawals.map(withdrawal => {
          return database.ref('users/' + withdrawal.userId).once('value').then(userSnapshot => {
            return {
              ...withdrawal,
              userName: userSnapshot.val()?.name || 'Unknown User'
            };
          });
        });
        
        Promise.all(userPromises).then(withdrawalsWithUsers => {
          // Render withdrawals table
          const withdrawalsTableBody = document.getElementById('withdrawals-table-body');
          withdrawalsTableBody.innerHTML = '';
          
          withdrawalsWithUsers.forEach(withdrawal => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${withdrawal.userName}</td>
              <td>${withdrawal.method || '-'}</td>
              <td>₹${withdrawal.amount || '0'}</td>
              <td>${getStatusBadge(withdrawal.status)}</td>
              <td>${formatDate(withdrawal.requestedAt)}</td>
              <td>
                <button class="action-btn btn-approve" data-withdrawalid="${withdrawal.id}" data-userid="${withdrawal.userId}">
                  <i class="fas fa-check"></i> Approve
                </button>
                <button class="action-btn btn-reject" data-withdrawalid="${withdrawal.id}" data-userid="${withdrawal.userId}">
                  <i class="fas fa-times"></i> Reject
                </button>
              </td>
            `;
            withdrawalsTableBody.appendChild(row);
          });
          
          // Add event listeners to action buttons
          document.querySelectorAll('.btn-approve').forEach(btn => {
            btn.addEventListener('click', () => {
              const withdrawalId = btn.getAttribute('data-withdrawalid');
              const userId = btn.getAttribute('data-userid');
              updateWithdrawalStatus(userId, withdrawalId, 'completed');
            });
          });
          
          document.querySelectorAll('.btn-reject').forEach(btn => {
            btn.addEventListener('click', () => {
              const withdrawalId = btn.getAttribute('data-withdrawalid');
              const userId = btn.getAttribute('data-userid');
              updateWithdrawalStatus(userId, withdrawalId, 'rejected');
            });
          });
          
          // Render pagination
          renderPagination('withdrawals-pagination', currentWithdrawalsPage, totalPages, loadWithdrawals);
        });
      });
    }

    // Update withdrawal status
    function updateWithdrawalStatus(userId, withdrawalId, status) {
      const updates = {
        status,
        processedAt: Date.now()
      };
      
      database.ref(`withdrawals/${userId}/${withdrawalId}`).update(updates)
        .then(() => {
          showStatus(`Withdrawal ${status} successfully!`, 'ok');
          loadWithdrawals(currentWithdrawalsPage);
          loadDashboardData(); // Refresh dashboard stats
        })
        .catch(error => {
          showStatus('Error updating withdrawal: ' + error.message, 'err');
        });
    }

    // Load messages
    function loadMessages(page = 1) {
      database.ref('contactMessages').once('value').then(snapshot => {
        const messages = [];
        snapshot.forEach(messageSnapshot => {
          messages.push({
            id: messageSnapshot.key,
            ...messageSnapshot.val()
          });
        });
        
        // Apply search if any
        const searchTerm = document.getElementById('message-search').value.toLowerCase();
        const filteredMessages = searchTerm ? 
          messages.filter(message => 
            (message.name && message.name.toLowerCase().includes(searchTerm)) ||
            (message.email && message.email.toLowerCase().includes(searchTerm)) ||
            (message.company && message.company.toLowerCase().includes(searchTerm)) ||
            (message.message && message.message.toLowerCase().includes(searchTerm))
          ) : messages;
        
        // Sort by date (newest first)
        filteredMessages.sort((a, b) => {
          const dateA = new Date(a.createdAt || 0);
          const dateB = new Date(b.createdAt || 0);
          return dateB - dateA;
        });
        
        // Pagination
        const totalPages = Math.ceil(filteredMessages.length / itemsPerPage);
        currentMessagesPage = Math.min(page, totalPages);
        const startIndex = (currentMessagesPage - 1) * itemsPerPage;
        const paginatedMessages = filteredMessages.slice(startIndex, startIndex + itemsPerPage);
        
        // Render messages table
        const messagesTableBody = document.getElementById('messages-table-body');
        messagesTableBody.innerHTML = '';
        
        paginatedMessages.forEach(message => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${message.name || '-'}</td>
            <td>${message.company || '-'}</td>
            <td>${message.email || '-'}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${message.message || '-'}</td>
            <td>${formatDate(message.createdAt)}</td>
            <td>${message.read ? 'Read' : 'Unread'}</td>
            <td>
              <button class="action-btn btn-view" data-messageid="${message.id}">
                <i class="fas fa-eye"></i> View
              </button>
              ${!message.read ? `
                <button class="action-btn btn-success" data-messageid="${message.id}">
                  <i class="fas fa-check"></i> Mark Read
                </button>
              ` : ''}
            </td>
          `;
          messagesTableBody.appendChild(row);
        });
        
        // Add event listeners to action buttons
        document.querySelectorAll('.btn-view').forEach(btn => {
          btn.addEventListener('click', () => {
            const messageId = btn.getAttribute('data-messageid');
            viewMessage(messageId);
          });
        });
        
        document.querySelectorAll('.btn-success').forEach(btn => {
          btn.addEventListener('click', () => {
            const messageId = btn.getAttribute('data-messageid');
            markMessageAsRead(messageId);
          });
        });
        
        // Render pagination
        renderPagination('messages-pagination', currentMessagesPage, totalPages, loadMessages);
      });
    }

    // View message details
    function viewMessage(messageId) {
      database.ref('contactMessages/' + messageId).once('value').then(snapshot => {
        const message = snapshot.val();
        if (!message) return;
        
        alert(`Message from: ${message.name} (${message.email})\nCompany: ${message.company || 'N/A'}\n\nMessage:\n${message.message}`);
        
        // Mark as read when viewed
        if (!message.read) {
          markMessageAsRead(messageId);
        }
      });
    }

    // Mark message as read
    function markMessageAsRead(messageId) {
      database.ref('contactMessages/' + messageId).update({
        read: true,
        readAt: Date.now()
      }).then(() => {
        showStatus('Message marked as read', 'ok');
        loadMessages(currentMessagesPage);
        loadDashboardData(); // Refresh dashboard stats
      }).catch(error => {
        showStatus('Error updating message: ' + error.message, 'err');
      });
    }

    // Mark all messages as read
    document.getElementById('btn-mark-all-read').addEventListener('click', () => {
      database.ref('contactMessages').once('value').then(snapshot => {
        const updates = {};
        snapshot.forEach(messageSnapshot => {
          if (!messageSnapshot.val().read) {
            updates[`${messageSnapshot.key}/read`] = true;
            updates[`${messageSnapshot.key}/readAt`] = Date.now();
          }
        });
        
        database.ref('contactMessages').update(updates)
          .then(() => {
            showStatus('All messages marked as read', 'ok');
            loadMessages(currentMessagesPage);
            loadDashboardData(); // Refresh dashboard stats
          })
          .catch(error => {
            showStatus('Error updating messages: ' + error.message, 'err');
          });
      });
    });

    // Load brands (placeholder)
    function loadBrands() {
      document.getElementById('brands-table-body').innerHTML = `
        <tr><td colspan="5" style="text-align:center;padding:20px">Brand management functionality coming soon</td></tr>
      `;
    }

    // Load campaigns (placeholder)
    function loadCampaigns() {
      document.getElementById('campaigns-table-body').innerHTML = `
        <tr><td colspan="6" style="text-align:center;padding:20px">Campaign management functionality coming soon</td></tr>
      `;
    }

    // Render pagination controls
    function renderPagination(elementId, currentPage, totalPages, callback) {
      const paginationEl = document.getElementById(elementId);
      paginationEl.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.innerHTML = '&laquo;';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) callback(currentPage - 1);
      });
      paginationEl.appendChild(prevBtn);
      
      // Page buttons
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.addEventListener('click', () => callback(i));
        paginationEl.appendChild(pageBtn);
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.innerHTML = '&raquo;';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) callback(currentPage + 1);
      });
      paginationEl.appendChild(nextBtn);
    }

    // Search functionality
    document.getElementById('user-search').addEventListener('input', () => {
      loadUsers(1);
    });
    
    document.getElementById('submission-search').addEventListener('input', () => {
      loadSubmissions(1);
    });
    
    document.getElementById('submission-filter').addEventListener('change', () => {
      loadSubmissions(1);
    });
    
    document.getElementById('withdrawal-search').addEventListener('input', () => {
      loadWithdrawals(1);
    });
    
    document.getElementById('withdrawal-filter').addEventListener('change', () => {
      loadWithdrawals(1);
    });
    
    document.getElementById('message-search').addEventListener('input', () => {
      loadMessages(1);
    });

    // Refresh buttons
    document.getElementById('btn-refresh-users').addEventListener('click', () => {
      loadUsers(currentUsersPage);
    });

    // Initialize
    setupPasswordToggle('admin-pass-toggle', 'admin-pass');
    
    // Check if user is already logged in
    auth.onAuthStateChanged(user => {
      if (user && user.email === 'rudrchauhan877@gmail.com') {
        currentUser = user;
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('admin-dashboard').style.display = 'block';
        document.getElementById('nav-logout').style.display = 'list-item';
        loadDashboardData();
      } else if (user) {
        // Signed in but not the admin user
        auth.signOut();
      }
    });
  </script>
</body>
</html>